# Fastfile для автоматической сборки и публикации iOS приложения

default_platform(:ios)

platform :ios do
  desc "Build archive"
  lane :build_archive do |options|
    # Сборка архива
    build_app(
      workspace: nil,
      project: "BirdEggs.xcodeproj",
      scheme: "BirdEggs",
      export_method: "app-store",
      export_options: {
        method: "app-store",
        uploadBitcode: false,
        uploadSymbols: true,
        compileBitcode: false,
        signingStyle: "automatic"
      },
      output_directory: "./build",
      output_name: "BirdEggs.ipa",
      clean: true,
      configuration: "Release"
    )
  end

  desc "Upload to App Store Connect"
  lane :upload_to_app_store do |options|
    # Загрузка в App Store Connect через API
    upload_to_app_store(
      api_key_path: "~/.appstoreconnect/private_keys/AuthKey.p8",
      api_key: {
        key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
        issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
        key_filepath: "~/.appstoreconnect/private_keys/AuthKey.p8",
        duration: 1200,
        in_house: false
      },
      skip_screenshots: true,
      skip_metadata: true,
      force: true,
      submit_for_review: false,
      automatic_release: false
    )
  end

  desc "Build and publish"
  lane :build_and_publish do |options|
    build_archive
    upload_to_app_store
  end
end

