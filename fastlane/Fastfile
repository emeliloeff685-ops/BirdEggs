# Fastfile для автоматической сборки и публикации iOS приложения

default_platform(:ios)

platform :ios do
  desc "Build archive"
  lane :build_archive do |options|
    # Настройка API ключа через переменные окружения
    # Fastlane автоматически использует API ключ из переменных окружения
    # или из файла ~/.appstoreconnect/private_keys/
    
    # Сборка архива с автоматической подписью
    build_app(
      workspace: nil,
      project: "BirdEggs.xcodeproj",
      scheme: "BirdEggs",
      export_method: "app-store",
      export_options: {
        method: "app-store",
        uploadBitcode: false,
        uploadSymbols: true,
        compileBitcode: false,
        signingStyle: "automatic",
        teamID: ENV["DEVELOPMENT_TEAM"]
      },
      output_directory: "./build",
      output_name: "BirdEggs.ipa",
      clean: true,
      configuration: "Release"
    )
  end

  desc "Upload IPA to App Store Connect"
  lane :upload_ipa do |options|
    # Загрузка в App Store Connect через API
    # API ключ будет автоматически использован из переменных окружения
    upload_to_app_store(
      skip_screenshots: true,
      skip_metadata: true,
      force: true,
      submit_for_review: false,
      automatic_release: false
    )
  end

  desc "Build and publish"
  lane :build_and_publish do |options|
    build_archive
    upload_ipa
  end
end

