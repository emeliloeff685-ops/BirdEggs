name: Build and Publish iOS App (Simple)

on:
  push:
    tags:
      - 'v*'  # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–µ–≥–∞ –≤–∏–¥–∞ v1.0.0
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –∏–∑ GitHub UI

jobs:
  build-and-publish:
    runs-on: macos-14
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
      
      - name: Install Fastlane
        run: gem install fastlane
        continue-on-error: true
      
      - name: Setup App Store Connect API Key
        env:
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$APP_STORE_CONNECT_API_KEY_CONTENT" > ~/.appstoreconnect/private_keys/AuthKey.p8
          chmod 600 ~/.appstoreconnect/private_keys/AuthKey.p8
      
      - name: Setup Code Signing (if certificates provided)
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
          if [ -z "$BUILD_CERTIFICATE_BASE64" ] || [ -z "$BUILD_PROVISION_PROFILE_BASE64" ]; then
            echo "‚ö†Ô∏è Certificates not provided, skipping manual code signing setup"
            echo "Will use automatic code signing"
            exit 0
          fi
          
          echo "üîê Setting up manual code signing..."
          
          # –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          
          # –î–µ–∫–æ–¥–∏—Ä—É–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏ provisioning profile
          echo "$BUILD_CERTIFICATE_BASE64" | base64 --decode > $CERTIFICATE_PATH
          echo "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode > $PP_PATH
          
          # –°–æ–∑–¥–∞—ë–º keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
          
          # –ü—Ä–∏–º–µ–Ω—è–µ–º provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º UUID –∏–∑ provisioning profile
          PP_UUID=$(/usr/libexec/PlistBuddy -c "Print UUID" /dev/stdin <<< $(security cms -D -i "$PP_PATH") 2>/dev/null || \
            grep -aA1 UUID "$PP_PATH" | grep -o '[-A-F0-9]\{36\}' | head -1)
          
          if [ -z "$PP_UUID" ]; then
            echo "‚ö†Ô∏è Could not extract UUID from provisioning profile, using filename"
            PP_UUID=$(basename "$PP_PATH" .mobileprovision)
          fi
          
          PP_DEST="$HOME/Library/MobileDevice/Provisioning Profiles/${PP_UUID}.mobileprovision"
          cp "$PP_PATH" "$PP_DEST"
          
          echo "Provisioning Profile UUID: $PP_UUID"
          echo "Provisioning Profile path: $PP_DEST"
          
          # –ü–æ–ª—É—á–∞–µ–º identity —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
          CERT_IDENTITY=$(security find-identity -v -p codesigning $KEYCHAIN_PATH | head -1 | grep -o '".*"' | sed 's/"//g')
          echo "CERT_IDENTITY=$CERT_IDENTITY" >> $GITHUB_ENV
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV
          echo "PROVISIONING_PROFILE_UUID=$PP_UUID" >> $GITHUB_ENV
          echo "‚úÖ Code signing setup completed"
      
      - name: Build Archive
        env:
          DEVELOPMENT_TEAM: ${{ secrets.DEVELOPMENT_TEAM }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: |
          echo "Building archive with Team ID: $DEVELOPMENT_TEAM"
          set -o pipefail
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–æ–¥ –ø–æ–¥–ø–∏—Å–∏
          if [ -n "$CERT_IDENTITY" ] && [ -n "$KEYCHAIN_PATH" ] && [ -n "$PROVISIONING_PROFILE_UUID" ]; then
            echo "Using manual code signing with certificate: $CERT_IDENTITY"
            echo "Using provisioning profile: $PROVISIONING_PROFILE_UUID"
            
            # –°–æ–±–∏—Ä–∞–µ–º –∞—Ä—Ö–∏–≤ —Å —Ä—É—á–Ω–æ–π –ø–æ–¥–ø–∏—Å—å—é
            xcodebuild clean archive \
              -project BirdEggs.xcodeproj \
              -scheme BirdEggs \
              -archivePath $RUNNER_TEMP/BirdEggs.xcarchive \
              -configuration Release \
              CODE_SIGN_STYLE="Manual" \
              CODE_SIGN_IDENTITY="$CERT_IDENTITY" \
              PROVISIONING_PROFILE_SPECIFIER="$PROVISIONING_PROFILE_UUID" \
              DEVELOPMENT_TEAM="$DEVELOPMENT_TEAM" \
              2>&1 | tee build.log
          else
            echo "Using Fastlane for build with App Store Connect API"
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º fastlane –¥–ª—è —Å–±–æ—Ä–∫–∏ —Å API –∫–ª—é—á–æ–º
            # Fastlane –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç API –∫–ª—é—á –¥–ª—è –ø–æ–¥–ø–∏—Å–∏
            fastlane build_archive 2>&1 | tee build.log || {
              
              echo "‚ö†Ô∏è Fastlane build failed"
              echo "Trying alternative: xcodebuild with export only signing..."
              exit 1
            }
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∞—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω
            if [ -f "./build/BirdEggs.ipa" ]; then
              echo "‚úÖ IPA file created successfully"
              cp ./build/BirdEggs.ipa $RUNNER_TEMP/BirdEggs.ipa
              # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º workflow
              mkdir -p $RUNNER_TEMP/BirdEggs.xcarchive
            else
              echo "‚ùå IPA file not found"
              exit 1
            fi
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "‚ùå Build failed with exit code $BUILD_EXIT_CODE"
            echo ""
            echo "=== Build Log (last 100 lines) ==="
            tail -100 build.log
            echo ""
            echo "=== Checking for common issues ==="
            grep -i "error\|warning\|failed" build.log | tail -20 || echo "No specific errors found"
            echo ""
            echo "üí° Tip: If you see 'No Accounts' error, you need to:"
            echo "   1. Export your certificate (.p12) and provisioning profile"
            echo "   2. Add them to GitHub Secrets as BUILD_CERTIFICATE_BASE64 and BUILD_PROVISION_PROFILE_BASE64"
            exit 1
          fi
          
          echo "‚úÖ Archive built successfully"
      
      - name: Export IPA (if not using Fastlane)
        if: env.FASTLANE_BUILD != 'true'
        env:
          DEVELOPMENT_TEAM: ${{ secrets.DEVELOPMENT_TEAM }}
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞—Ä—Ö–∏–≤–∞
          if [ ! -d "$RUNNER_TEMP/BirdEggs.xcarchive" ] && [ ! -f "$RUNNER_TEMP/BirdEggs.ipa" ]; then
            echo "‚ùå Archive not found!"
            exit 1
          fi
          
          # –ï—Å–ª–∏ IPA —É–∂–µ —Å–æ–∑–¥–∞–Ω fastlane, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —ç–∫—Å–ø–æ—Ä—Ç
          if [ -f "$RUNNER_TEMP/BirdEggs.ipa" ]; then
            echo "‚úÖ IPA already created by Fastlane"
            exit 0
          fi
          
          # –û–±–Ω–æ–≤–ª—è–µ–º exportOptions.plist –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä—É—á–Ω–∞—è –ø–æ–¥–ø–∏—Å—å
          if [ -n "$PROVISIONING_PROFILE_UUID" ]; then
            echo "Updating exportOptions.plist for manual signing with UUID: $PROVISIONING_PROFILE_UUID"
            # –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π plist —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∏—Å–ø–æ–ª—å–∑—É—è PlistBuddy
            cp exportOptions.plist exportOptions_manual.plist
            /usr/libexec/PlistBuddy -c 'Set :method app-store-connect' exportOptions_manual.plist
            /usr/libexec/PlistBuddy -c 'Set :signingStyle manual' exportOptions_manual.plist
            /usr/libexec/PlistBuddy -c "Set ':provisioningProfiles:com.collector.eggscollector.BirdEggs1' '$PROVISIONING_PROFILE_UUID'" exportOptions_manual.plist
            EXPORT_OPTIONS_FILE="exportOptions_manual.plist"
          else
            EXPORT_OPTIONS_FILE="exportOptions.plist"
          fi
          
          # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º IPA
          xcodebuild -exportArchive \
            -archivePath $RUNNER_TEMP/BirdEggs.xcarchive \
            -exportPath $RUNNER_TEMP/export \
            -exportOptionsPlist "$EXPORT_OPTIONS_FILE" \
            2>&1 | tee export.log || {
            echo "Export failed, checking logs..."
            cat export.log
            exit 1
          }
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ IPA
          if [ ! -f "$RUNNER_TEMP/export/BirdEggs.ipa" ]; then
            echo "‚ùå IPA file not found!"
            ls -la $RUNNER_TEMP/export/
            exit 1
          fi
          
          # –ö–æ–ø–∏—Ä—É–µ–º IPA –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –º–µ—Å—Ç–æ
          cp $RUNNER_TEMP/export/BirdEggs.ipa $RUNNER_TEMP/BirdEggs.ipa
          
          echo "‚úÖ IPA exported successfully"
      
      - name: Upload to App Store Connect
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: |
          echo "üì§ Uploading IPA to App Store Connect..."
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ IPA —Ñ–∞–π–ª—É
          if [ -f "$RUNNER_TEMP/BirdEggs.ipa" ]; then
            IPA_PATH="$RUNNER_TEMP/BirdEggs.ipa"
          elif [ -f "$RUNNER_TEMP/export/BirdEggs.ipa" ]; then
            IPA_PATH="$RUNNER_TEMP/export/BirdEggs.ipa"
          elif [ -f "./build/BirdEggs.ipa" ]; then
            IPA_PATH="./build/BirdEggs.ipa"
          else
            echo "‚ùå IPA file not found!"
            echo "Searching for IPA files..."
            find $RUNNER_TEMP -name "*.ipa" 2>/dev/null || echo "No IPA files found"
            exit 1
          fi
          
          echo "IPA file: $IPA_PATH"
          echo "IPA file size: $(du -h "$IPA_PATH" | cut -f1)"
          
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è API –∫–ª—é—á–∞
          API_KEY_PATH=~/.appstoreconnect/private_keys/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$APP_STORE_CONNECT_API_KEY_CONTENT" > "$API_KEY_PATH"
          chmod 600 "$API_KEY_PATH"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ fastlane
          if ! command -v fastlane &> /dev/null; then
            echo "‚ö†Ô∏è Fastlane not found, installing..."
            gem install fastlane
          fi
          
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º fastlane deliver –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ (–ª—É—á—à–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å API –∫–ª—é—á–∞–º–∏)
          echo "üì§ Uploading with fastlane deliver..."
          
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è API –∫–ª—é—á–∞
          API_KEY_PATH=~/.appstoreconnect/private_keys/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$APP_STORE_CONNECT_API_KEY_CONTENT" > "$API_KEY_PATH"
          chmod 600 "$API_KEY_PATH"
          
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º fastlane deliver –Ω–∞–ø—Ä—è–º—É—é —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
          fastlane deliver \
            --ipa "$IPA_PATH" \
            --api_key_path "$API_KEY_PATH" \
            --api_key "$APP_STORE_CONNECT_API_KEY_ID" \
            --api_issuer "$APP_STORE_CONNECT_ISSUER_ID" \
            --app_identifier "com.collector.eggscollector.BirdEggs1" \
            --skip_screenshots \
            --skip_metadata \
            --skip_app_version_update \
            --force \
            --submit_for_review false \
            --verbose \
            2>&1 | tee upload.log || {
              
              # –ï—Å–ª–∏ fastlane deliver –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–±—É–µ–º xcrun altool
              echo "‚ö†Ô∏è fastlane deliver failed, trying xcrun altool..."
              
              xcrun altool --upload-app \
                --type ios \
                --file "$IPA_PATH" \
                --apiKey "$APP_STORE_CONNECT_API_KEY_ID" \
                --apiIssuer "$APP_STORE_CONNECT_ISSUER_ID" \
                --verbose \
                2>&1 | tee -a upload.log || {
              echo "‚ùå Upload failed!"
              echo ""
              echo "=== Upload Log (last 100 lines) ==="
              tail -100 upload.log
              echo ""
              echo "=== Common Issues ==="
              echo "1. App not found in App Store Connect"
              echo "   ‚Üí Create app at: https://appstoreconnect.apple.com"
              echo "   ‚Üí Bundle ID must match: com.collector.eggscollector.BirdEggs1"
              echo ""
              echo "2. API Key issues"
              echo "   ‚Üí Check Key ID: $APP_STORE_CONNECT_API_KEY_ID"
              echo "   ‚Üí Check Issuer ID: $APP_STORE_CONNECT_ISSUER_ID"
              echo "   ‚Üí Verify key has 'App Manager' or 'Admin' access"
              echo ""
              echo "3. Check App Store Connect Activity"
              echo "   ‚Üí Go to: https://appstoreconnect.apple.com"
              echo "   ‚Üí My Apps ‚Üí Your App ‚Üí Activity"
              echo ""
              exit 1
            }
          }
          
          echo "‚úÖ Upload completed successfully!"
          echo "üì± Check App Store Connect: https://appstoreconnect.apple.com"
          echo "   Go to: My Apps ‚Üí Your App ‚Üí TestFlight or App Store ‚Üí Versions"
      
      - name: Cleanup Keychain
        if: always()
        env:
          KEYCHAIN_PATH: ${{ env.KEYCHAIN_PATH }}
        run: |
          if [ -n "$KEYCHAIN_PATH" ]; then
            if [ -f "$KEYCHAIN_PATH" ]; then
              security delete-keychain $KEYCHAIN_PATH || true
            fi
            rm -rf ~/Library/MobileDevice/Provisioning\ Profiles/* || true
          fi
